<!DOCTYPE html>
<html>
<head>
    <title>RAW SQL → Drizzle Schema Code Generator</title>
    <meta charset="utf-8" />
    <style>
      :root {
        --accent: #1e90ff;
        --accent-dark: #1674cc;
        --ok: #12b886;
        --ok-dark: #0f9a72;
        --muted: #f7f7f7;
        --border: #d0d7de;
      }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
      textarea { width: 100%; max-width: 960px; height: 220px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
      .btn { display: inline-block; margin: 6px 8px 6px 0; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--muted); cursor: pointer; transition: background .15s, color .15s, border-color .15s; }
      .btn:hover { background: #eee; }
      .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
      .btn-primary:disabled { opacity: .65; cursor: not-allowed; }
      .btn-ok { background: var(--ok); color: #fff; border-color: var(--ok); }
      .btn-ok:hover { background: var(--ok-dark); border-color: var(--ok-dark); }
      .btn-copied { background: #16a34a !important; color: #fff !important; border-color: #16a34a !important; }
      .btn-clean { background: #fff; border-color: var(--border); }
      .row { margin: 8px 0; }
      pre { background: #0b1021; color: #e6e6e6; padding: 16px; border-radius: 8px; max-width: 960px; overflow: auto; }
      .hint { color: #666; font-size: 13px; }
      .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
      .spacer { flex: 1; }
    </style>
</head>
<body>
    <h1>RAW SQL → Drizzle Schema Code Generator</h1>

    <form id="sqlForm" method="POST">
        <div class="row">
          <textarea id="sqlInput" name="sql" placeholder="Paste your CREATE TABLE SQL here..."></textarea>
        </div>

        <div class="row toolbar">
          <button type="button" class="btn" id="btnAddPk">Add PK to first col</button>
          <button type="button" class="btn" id="btnAddIdentity">Add auto increment to first col</button>
          <button type="button" class="btn btn-clean" id="btnClean">Clean</button>
          <div class="spacer"></div>
          <button type="button" class="btn btn-primary" id="btnGenerate">Generate code</button>
          <button type="button" class="btn btn-primary" id="btnGeneratePg">Generate raw Postgres query</button>
        </div>
    </form>
    <div id="outWrap" style="display:none;">
  <h2>Generated Drizzle Code:</h2>
  <pre id="drizzleOut"></pre>
  <button type="button" class="btn" id="btnCopy">Copy code</button>
</div>

<script>
  function getCreateBody(sql) {
    const createIdx = sql.search(/CREATE\s+TABLE/i);
    if (createIdx === -1) return null;
    const openIdx = sql.indexOf('(', createIdx);
    if (openIdx === -1) return null;
    let depth = 0, closeIdx = -1;
    for (let i = openIdx; i < sql.length; i++) {
      const ch = sql[i];
      if (ch === '(') depth++;
      else if (ch === ')') {
        depth--;
        if (depth === 0) { closeIdx = i; break; }
      }
    }
    if (closeIdx === -1) return null;
    return { openIdx, closeIdx, inner: sql.slice(openIdx + 1, closeIdx) };
  }

  function splitTopLevel(inner) {
    const out = [];
    let buf = '', depth = 0;
    for (let i = 0; i < inner.length; i++) {
      const ch = inner[i];
      if (ch === '(') { depth++; buf += ch; }
      else if (ch === ')') { depth--; buf += ch; }
      else if (ch === ',' && depth === 0) { out.push(buf.trim()); buf = ''; }
      else { buf += ch; }
    }
    if (buf.trim()) out.push(buf.trim());
    return out;
  }

  function ensurePrimaryKeyOnFirstCol(sql) {
    const body = getCreateBody(sql);
    if (!body) return sql;
    const items = splitTopLevel(body.inner);
    if (!items.length) return sql;
    let firstIdx = -1;
    for (let i = 0; i < items.length; i++) {
      const u = items[i].toUpperCase();
      if (!u.startsWith('PRIMARY KEY') && !u.startsWith('FOREIGN KEY') && !u.startsWith('UNIQUE') &&
          !u.startsWith('CHECK') && !u.startsWith('CONSTRAINT')) { firstIdx = i; break; }
    }
    if (firstIdx === -1) return sql;
    let first = items[firstIdx];
    if (!/\bPRIMARY\s+KEY\b/i.test(first)) {
      first = first.replace(/\s+$/, '') + ' PRIMARY KEY';
      items[firstIdx] = first;
    }
    const newInner = items.join(',\n  ');
    return sql.slice(0, body.openIdx + 1) + '\n  ' + newInner + '\n' + sql.slice(body.closeIdx);
  }

  function ensureIdentityOnFirstCol(sql) {
    const body = getCreateBody(sql);
    if (!body) return sql;
    const items = splitTopLevel(body.inner);
    if (!items.length) return sql;
    let firstIdx = -1;
    for (let i = 0; i < items.length; i++) {
      const u = items[i].toUpperCase();
      if (!u.startsWith('PRIMARY KEY') && !u.startsWith('FOREIGN KEY') && !u.startsWith('UNIQUE') &&
          !u.startsWith('CHECK') && !u.startsWith('CONSTRAINT')) { firstIdx = i; break; }
    }
    if (firstIdx === -1) return sql;
    let first = items[firstIdx];

    const m = first.trim().match(/^([A-Za-z_]\w*)(\s+.+)?$/);
    if (m) {
      const name = m[1];
      const rest = m[2] ? m[2] : '';
      if (!/\b(BIGINT|SMALLINT|INT|INTEGER)\b/i.test(rest)) {
        first = name + ' INT' + (rest || '');
      }
    }
    if (!/\bGENERATED\s+(ALWAYS|BY\s+DEFAULT)\s+AS\s+IDENTITY\b/i.test(first)) {
      if (/\bPRIMARY\s+KEY\b/i.test(first)) {
        first = first.replace(/\bPRIMARY\s+KEY\b/i, 'GENERATED ALWAYS AS IDENTITY PRIMARY KEY');
      } else {
        first = first.replace(/\s+$/, '') + ' GENERATED ALWAYS AS IDENTITY';
      }
    }
    if (!/\bPRIMARY\s+KEY\b/i.test(first)) {
      first = first.replace(/\s+$/, '') + ' PRIMARY KEY';
    }
    items[firstIdx] = first;
    const newInner = items.join(',\n  ');
    return sql.slice(0, body.openIdx + 1) + '\n  ' + newInner + '\n' + sql.slice(body.closeIdx);
  }

  function cleanSql(sql) {
    if (!sql) return sql;
    let out = sql.replace(/\r\n/g, '\n');
    out = out.replace(/[ \t]+\n/g, '\n');
    out = out.replace(/\n{3,}/g, '\n\n');
    out = out.replace(/[ ]{2,}/g, ' ');
    out = out.replace(/`/g, '');
    return out.trimStart();
  }

  document.addEventListener('DOMContentLoaded', function() {
    const sqlInput = document.getElementById('sqlInput');
    const btnAddPk = document.getElementById('btnAddPk');
    const btnAddIdentity = document.getElementById('btnAddIdentity');
    const btnClean = document.getElementById('btnClean');
    const btnGenerate = document.getElementById('btnGenerate');
    const btnGeneratePg = document.getElementById('btnGeneratePg');
    const outWrap = document.getElementById('outWrap');
    const drizzleOut = document.getElementById('drizzleOut');
    const btnCopy = document.getElementById('btnCopy');

    btnAddPk.addEventListener('click', function() {
      sqlInput.value = ensurePrimaryKeyOnFirstCol(sqlInput.value || '');
    });

    btnAddIdentity.addEventListener('click', function() {
      sqlInput.value = ensureIdentityOnFirstCol(sqlInput.value || '');
    });

    // Clean should normalize, not clear
    btnClean.addEventListener('click', function() {
      sqlInput.value = ('');
      drizzleOut.textContent = ('');
    });

    btnGenerate.addEventListener('click', async function() {
      btnGenerate.disabled = true;
      const prev = btnGenerate.textContent;
      btnGenerate.textContent = 'Generating...';
      try {
        const res = await fetch('/api/drizzle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sql: sqlInput.value || '' })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Failed');
        drizzleOut.textContent = data.code || '';
        outWrap.style.display = 'block';
      } catch (err) {
        alert('Error: ' + err.message);
      } finally {
        btnGenerate.textContent = prev;
        btnGenerate.disabled = false;
      }
    });

    btnGeneratePg.addEventListener('click', async function() {
      btnGeneratePg.disabled = true;
      const prev = btnGeneratePg.textContent;
      btnGeneratePg.textContent = 'Generating...';
      try {
        const res = await fetch('/api/postgres', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sql: sqlInput.value || '' })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Failed');
        const w = window.open('', '_blank', 'width=900,height=600');
        if (w) {
          const escaped = (data.sql || '').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
          w.document.write('<pre style="white-space:pre-wrap; font-family:monospace; padding:12px;">' + escaped + '</pre>');
          w.document.title = 'Raw Postgres Query';
        } else {
          alert('Popup blocked: could not open preview window.');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      } finally {
        btnGeneratePg.textContent = prev;
        btnGeneratePg.disabled = false;
      }
    });

    // Single copy handler
    if (btnCopy) {
      btnCopy.addEventListener('click', async function() {
        const text = drizzleOut.textContent || '';
        try {
          await navigator.clipboard.writeText(text);
          btnCopy.classList.add('btn-copied');
          btnCopy.textContent = 'Copied!';
          setTimeout(() => {
            btnCopy.classList.remove('btn-copied');
            btnCopy.textContent = 'Copy code';
          }, 1200);
        } catch (e) {
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          btnCopy.classList.add('btn-copied');
          btnCopy.textContent = 'Copied!';
          setTimeout(() => {
            btnCopy.classList.remove('btn-copied');
            btnCopy.textContent = 'Copy code';
          }, 1200);
        }
      });
    }
  });
</script>

</body>
</html>
